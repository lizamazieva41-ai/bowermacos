openapi: "3.1.0"
info:
  title: BrowserManager Local API
  version: "1.1.0"
  description: |
    Local API for BrowserManager Agent.
    Runs on 127.0.0.1 (localhost only). Requires Bearer token.

    ## Modes
    - **Native mode**: Uses `{data, request_id, timestamp}` envelope
    - **MoreLogin-compat mode**: Uses `{code, msg, data, requestId}` envelope
      (enabled via config `compatibility.response_format: "morelogin"`)

    ## Usage
    Validate: `npx @redocly/cli lint openapi.yaml`

servers:
  - url: "http://127.0.0.1:40000"
    description: Local Agent (default port — MoreLogin-compatible)
  - url: "http://127.0.0.1:19000"
    description: Local Agent (alt port — if MoreLogin running on same machine)

components:
  securitySchemes:
    BearerToken:
      type: http
      scheme: bearer
      bearerFormat: Token
      description: >
        Bearer token authentication. In Phase 2 (RBAC), tokens carry a `role` claim
        (ADMIN | OPERATOR | VIEWER) that gates access to endpoints.
        See `09-bao-mat-va-luu-tru.md` §8F for full permission matrix.

  schemas:
    # ─── Envelopes ───────────────────────────────────────────────────────────

    NativeEnvelope:
      type: object
      description: "Native mode response envelope"
      properties:
        data:
          description: Payload
        request_id:
          type: string
        timestamp:
          type: string
          format: date-time

    CompatEnvelope:
      type: object
      description: "MoreLogin-compatible response envelope (compat mode)"
      properties:
        code:
          type: integer
          description: "0 = success; < 0 = error"
          example: 0
        msg:
          type: string
          example: "success"
        data:
          description: Payload
        requestId:
          type: string

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string
        request_id:
          type: string
        timestamp:
          type: string
          format: date-time

    # ─── Profile / Environment ────────────────────────────────────────────────

    ProfileCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
          maxLength: 100
          x-min-agent-version: "1.0.0"
        group_id:
          type: string
          format: uuid
          description: "FK → env_groups.id"
          x-min-agent-version: "1.1.0"
        group_name:
          type: string
          description: "Legacy string group (deprecated — use group_id)"
        remark:
          type: string
          maxLength: 500
          x-min-agent-version: "1.1.0"
        tags:
          type: array
          items:
            type: string
          deprecated: true
          description: "Legacy string tags (deprecated — use tag_ids)"
        tag_ids:
          type: array
          items:
            type: string
            format: uuid
          description: "UUIDs → env_tags.id (n-n)"
          x-min-agent-version: "1.1.0"
        start_url:
          type: string
          format: uri
        extensions:
          type: array
          items:
            type: string
        headless_default:
          type: boolean
          default: false
        proxy:
          $ref: "#/components/schemas/ProxyConfig"
        user_agent:
          type: string
        kernel_ver:
          type: string
        os_version:
          type: string
        screen_res:
          type: string
          example: "1920x1080"
        timezone:
          type: string
          example: "Asia/Ho_Chi_Minh"
        language:
          type: string
          example: "vi-VN"
        e2e_encryption_enabled:
          type: boolean
          default: false
          description: "[Restricted — interface only] When true, encryptKey required on start"
          x-min-agent-version: "1.1.0"
        lock_status:
          type: string
          enum: [unlocked, locked]
          default: unlocked
          description: "[Restricted — interface only] Locked profiles cannot be started"
          x-min-agent-version: "1.1.0"

    ProxyConfig:
      type: object
      required: [type, host, port]
      properties:
        type:
          type: string
          enum: [http, https, socks5, ssh]
        host:
          type: string
        port:
          type: integer
          minimum: 1
          maximum: 65535
        username:
          type: string
        password:
          type: string
          description: Will be encrypted before storage (DPAPI)

    Profile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        group_id:
          type: string
          format: uuid
          nullable: true
          x-min-agent-version: "1.1.0"
        group_name:
          type: string
          nullable: true
        remark:
          type: string
          nullable: true
          x-min-agent-version: "1.1.0"
        tag_ids:
          type: array
          items:
            type: string
            format: uuid
          x-min-agent-version: "1.1.0"
        tags:
          type: array
          items:
            type: string
          deprecated: true
        status:
          type: string
          enum: [inactive, active, error, deleted]
        lock_status:
          type: string
          enum: [unlocked, locked]
          x-min-agent-version: "1.1.0"
        e2e_encryption_enabled:
          type: boolean
          x-min-agent-version: "1.1.0"
        start_url:
          type: string
          nullable: true
        data_dir:
          type: string
        proxy_id:
          type: string
          nullable: true
        last_used_at:
          type: string
          format: date-time
          nullable: true
          x-min-agent-version: "1.1.0"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    # ─── Group ────────────────────────────────────────────────────────────────

    GroupCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
          maxLength: 100
        sort_order:
          type: integer
        color:
          type: string
          pattern: "^#[0-9A-Fa-f]{6}$"
          example: "#FF5733"

    Group:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        sort_order:
          type: integer
          nullable: true
        color:
          type: string
          nullable: true
        profile_count:
          type: integer
        created_at:
          type: string
          format: date-time

    # ─── Tag ─────────────────────────────────────────────────────────────────

    TagCreate:
      type: object
      required: [name, color]
      properties:
        name:
          type: string
          maxLength: 50
        color:
          type: string
          pattern: "^#[0-9A-Fa-f]{6}$"
          example: "#FF0000"

    Tag:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        color:
          type: string
        profile_count:
          type: integer
        created_at:
          type: string
          format: date-time

    # ─── Session ─────────────────────────────────────────────────────────────

    Session:
      type: object
      properties:
        id:
          type: string
          format: uuid
        profile_id:
          type: string
        status:
          type: string
          enum: [launching, running, stopped, crashed]
        pid:
          type: integer
          nullable: true
        debug_port:
          type: integer
          nullable: true
        webdriver:
          type: string
          description: "CDP WebDriver URL — e.g. http://127.0.0.1:9222"
          nullable: true
        version:
          type: string
          description: "Chromium version string"
          nullable: true
        headless:
          type: boolean
        started_at:
          type: string
          format: date-time
          nullable: true
        stopped_at:
          type: string
          format: date-time
          nullable: true

    SessionStart:
      type: object
      required: [profile_id]
      properties:
        profile_id:
          type: string
        headless:
          type: boolean
          default: false
        encrypt_key:
          type: string
          description: "[Restricted] Required if profile has e2e_encryption_enabled=true"

    # ─── Job ─────────────────────────────────────────────────────────────────

    Job:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
        profile_id:
          type: string
          nullable: true
        session_id:
          type: string
          nullable: true
        status:
          type: string
          enum: [queued, running, completed, failed, cancelled]
        result:
          type: object
          nullable: true
        error_msg:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true

    # ─── Agent ───────────────────────────────────────────────────────────────

    AgentStatus:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        version:
          type: string
        uptime_seconds:
          type: integer
        sessions:
          type: object
          properties:
            active:
              type: integer
            max:
              type: integer
        jobs:
          type: object
          properties:
            queued:
              type: integer
            running:
              type: integer

    # ─── Proxy ───────────────────────────────────────────────────────────────

    ProxyCreate:
      type: object
      required: [type, host, port]
      properties:
        label:
          type: string
        type:
          type: string
          enum: [http, https, socks5, ssh]
        host:
          type: string
        port:
          type: integer
          minimum: 1
          maximum: 65535
        username:
          type: string
        password:
          type: string
        refresh_url:
          type: string
          format: uri

    Proxy:
      type: object
      properties:
        id:
          type: string
          format: uuid
        label:
          type: string
          nullable: true
        type:
          type: string
        host:
          type: string
        port:
          type: integer
        username:
          type: string
          nullable: true
        refresh_url:
          type: string
          nullable: true
        last_checked:
          type: string
          format: date-time
          nullable: true
        last_status:
          type: string
          enum: [ok, timeout, auth_error]
          nullable: true
        profile_count:
          type: integer
          x-min-agent-version: "1.1.0"
        created_at:
          type: string
          format: date-time

    # ─── Webhook ─────────────────────────────────────────────────────────────

    WebhookCreate:
      type: object
      required: [url, events]
      properties:
        url:
          type: string
          format: uri
          description: HTTPS URL only; localhost/internal IPs are rejected
        events:
          type: array
          items:
            type: string
            enum: [job.completed, job.failed, job.cancelled, session.started, session.stopped, session.crashed, profile.created, profile.deleted]
        secret:
          type: string

    Webhook:
      type: object
      properties:
        id:
          type: string
          format: uuid
        url:
          type: string
        events:
          type: array
          items:
            type: string
        active:
          type: boolean
        created_at:
          type: string
          format: date-time
        last_triggered_at:
          type: string
          format: date-time
          nullable: true
        failure_count:
          type: integer

    # ─── Extension ───────────────────────────────────────────────────────────

    ExtensionCreate:
      type: object
      required: [source]
      properties:
        source:
          type: string
        name:
          type: string

    Extension:
      type: object
      properties:
        id:
          type: string
          format: uuid
        ext_id:
          type: string
        name:
          type: string
        version:
          type: string
          nullable: true
        source_url:
          type: string
          nullable: true
        assigned_profiles:
          type: integer
        verified:
          type: boolean
        created_at:
          type: string
          format: date-time

    # ─── Script ──────────────────────────────────────────────────────────────

    ScriptCreate:
      type: object
      required: [id, name, entry_file]
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        entry_file:
          type: string
        version:
          type: string
          default: "1.0.0"
        params_schema:
          type: object

    Script:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
          nullable: true
        version:
          type: string
        entry_file:
          type: string
        params_schema:
          type: object
          nullable: true
        registered_at:
          type: string
          format: date-time
        last_run_at:
          type: string
          format: date-time
          nullable: true

    # ─── Screen ──────────────────────────────────────────────────────────────

    ScreenInfo:
      type: object
      properties:
        monitor_index:
          type: integer
        resolution:
          type: string
          example: "1920x1080"
        dpi:
          type: integer
        is_primary:
          type: boolean

    # ─── ArrangeWindows ──────────────────────────────────────────────────────

    ArrangeWindowsRequest:
      type: object
      required: [ids]
      properties:
        ids:
          type: array
          items:
            type: string
          description: Profile IDs whose browser windows should be arranged
        layout:
          type: string
          enum: [grid, cascade, tile_horizontal, tile_vertical]
          default: grid
        monitor_index:
          type: integer
          default: 0

    # ─── Profile Sync (Sync Contract) ────────────────────────────────────────

    SyncPayload:
      type: object
      description: >
        Profile fields that are synchronised between agents.
        Excluded fields: data_dir, password_enc, e2e_encryption_enabled,
        lock_status, sessions, last_used_at.
      properties:
        name:
          type: string
        group_id:
          type: string
        remark:
          type: string
        tags:
          type: array
          items:
            type: string
        proxy_id:
          type: string
        start_url:
          type: string
        user_agent:
          type: string
        kernel_ver:
          type: string
        os_version:
          type: string
        screen_res:
          type: string
        timezone:
          type: string
        language:
          type: string
        headless_default:
          type: boolean
        extensions:
          type: array
          items:
            type: string
        metadata:
          type: object
          additionalProperties: true

    SyncUnit:
      type: object
      required: [schema_version, profile_id, agent_id, sync_version, operation, last_modified_at, checksum]
      description: >
        A single unit of profile sync data exchanged between agents.
        See `24-browser-sync-contract.md` §2.1 for full specification.
      properties:
        schema_version:
          type: string
          example: "1.0"
          description: "SemVer MAJOR.MINOR of the Sync Object schema"
        profile_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        agent_id:
          type: string
          example: "agent-primary-01"
        sync_version:
          type: integer
          minimum: 1
          description: "Monotonically increasing counter per profile per agent"
          example: 7
        operation:
          type: string
          enum: [create, update, delete]
          description: "Type of write operation that produced this SyncUnit"
          example: "update"
        last_modified_at:
          type: string
          format: date-time
          example: "2026-02-21T08:30:00Z"
        checksum:
          type: string
          description: 'SHA-256 of serialized payload; "none" when operation=delete'
          example: "sha256:aabbccdd..."
        payload:
          nullable: true
          allOf:
            - $ref: "#/components/schemas/SyncPayload"
          description: "Null when operation=delete"

    SyncPushResponse:
      type: object
      properties:
        accepted:
          type: boolean
          example: true
        profile_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        peer_sync_ver:
          type: integer
          example: 7
        resolved:
          type: string
          nullable: true
          enum: [last_write_wins, field_merge, null]
          example: null
        winning_agent:
          type: string
          nullable: true
          example: null

    SyncPullResponse:
      type: object
      properties:
        agent_id:
          type: string
          example: "agent-primary-01"
        units:
          type: array
          items:
            type: object
            properties:
              sync_unit:
                $ref: "#/components/schemas/SyncUnit"
        total:
          type: integer
          example: 2

    SyncCapabilitiesResponse:
      type: object
      properties:
        agent_id:
          type: string
          example: "agent-primary-01"
        schema_versions:
          type: array
          items:
            type: string
          example: ["1.0"]
        conflict_strategies:
          type: array
          items:
            type: string
          example: ["last_write_wins", "field_merge"]

  # ─── Standard Error Responses ────────────────────────────────────────────

  responses:

    BadRequest400:
      description: Bad Request — invalid input or missing required field
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/CompatEnvelope"
          example:
            code: -1601
            msg: "Bad request — invalid input"
            data: null
            requestId: "req-err-400"

    Unauthorized401:
      description: Unauthorized — missing or invalid Bearer token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/CompatEnvelope"
          example:
            code: -1501
            msg: "Unauthorized — token missing or invalid"
            data: null
            requestId: "req-err-401"

    Forbidden403:
      description: Forbidden — token valid but insufficient permissions (e.g. locked profile)
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/CompatEnvelope"
          example:
            code: -1503
            msg: "Forbidden — profile is locked"
            data: null
            requestId: "req-err-403"

    Conflict409:
      description: Conflict — resource state prevents the requested operation
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/CompatEnvelope"
          example:
            code: -1002
            msg: "Conflict — resource already exists or session is active"
            data: null
            requestId: "req-err-409"

    Validation422:
      description: Unprocessable Entity — semantic validation failure
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/CompatEnvelope"
          example:
            code: -1003
            msg: "Validation error — profile is currently active"
            data: null
            requestId: "req-err-422"

    RateLimit429:
      description: Too Many Requests — rate limit exceeded (default 100 req/s)
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/CompatEnvelope"
          example:
            code: -1502
            msg: "Too many requests — rate limit exceeded"
            data: null
            requestId: "req-err-429"

    SystemError500:
      description: Internal Server Error — unexpected agent-side failure
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/CompatEnvelope"
          example:
            code: -1701
            msg: "Internal server error"
            data: null
            requestId: "req-err-500"

    NotImplemented501:
      description: Not Implemented — feature not available in self-hosted agent
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/CompatEnvelope"
          example:
            code: -1801
            msg: "Not implemented — cloud-only feature not available on self-hosted BrowserManager"
            data: null
            requestId: "req-err-501"

security:
  - BearerToken: []

# ─────────────────────────────────────────────────────────────────────────────
# PATHS
# ─────────────────────────────────────────────────────────────────────────────

paths:

  # ─── Health / Agent ─────────────────────────────────────────────────────

  /health:
    get:
      summary: Healthcheck (no auth required)
      security: []
      x-min-agent-version: "1.0.0"
      responses:
        "200":
          description: Agent is running
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AgentStatus"

  /api/agent/status:
    get:
      summary: Agent status with metrics
      x-min-agent-version: "1.0.0"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AgentStatus"

  /api/agent/token/rotate:
    post:
      summary: Rotate API token
      x-min-agent-version: "1.0.0"
      responses:
        "200":
          description: New token (shown once only)
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  message:
                    type: string

  # ─── Native Profiles ────────────────────────────────────────────────────

  /api/profiles:
    get:
      summary: List profiles (native mode)
      x-min-agent-version: "1.0.0"
      parameters:
        - name: group
          in: query
          schema:
            type: string
        - name: group_id
          in: query
          schema:
            type: string
            format: uuid
        - name: tag
          in: query
          schema:
            type: string
        - name: tag_id
          in: query
          schema:
            type: string
            format: uuid
        - name: q
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [inactive, active, error]
        - name: proxy_type
          in: query
          schema:
            type: string
            enum: [http, https, socks5, ssh, none]
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        "200":
          description: Paginated profiles
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Profile"
                  total:
                    type: integer
                  page:
                    type: integer
    post:
      summary: Create profile (native mode)
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProfileCreate"
      responses:
        "201":
          description: Profile created
        "400":
          description: Validation error
        "409":
          description: Name already exists

  /api/profiles/{id}:
    get:
      summary: Get profile by ID
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Profile"
        "404":
          description: Not found
    patch:
      summary: Update profile
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProfileCreate"
      responses:
        "200":
          description: Updated
        "409":
          description: Has active session
    delete:
      summary: Soft-delete profile (→ trash)
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Deleted
        "409":
          description: Has active session

  /api/profiles/{id}/clone:
    post:
      summary: Clone profile
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                mode:
                  type: string
                  enum: [metadata_only, full_copy]
                  default: metadata_only
      responses:
        "201":
          description: Cloned

  /api/profiles/{id}/export:
    get:
      summary: Export profile as ZIP
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: exclude_secrets
          in: query
          schema:
            type: boolean
            default: true
        - name: include_data_dir
          in: query
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: ZIP file
          content:
            application/zip:
              schema:
                type: string
                format: binary

  /api/profiles/{id}/clear-cache:
    post:
      summary: Clear browser cache for profile
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [types]
              properties:
                types:
                  type: array
                  items:
                    type: string
                    enum: [cookies, local_storage, indexeddb, extension_data, all]
      responses:
        "200":
          description: Cache cleared
        "409":
          description: Has active session

  /api/profiles/trash:
    get:
      summary: List profiles in recycle bin
      x-min-agent-version: "1.0.0"
      responses:
        "200":
          description: Trashed profiles

  /api/profiles/{id}/restore:
    post:
      summary: Restore profile from trash (within 7 days)
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Restored
        "404":
          description: Not in trash or expired

  /api/profiles/{id}/permanent:
    delete:
      summary: Permanently delete profile (irrecoverable)
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Deleted

  /api/profiles/batch:
    post:
      summary: Batch update profiles
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [profile_ids, operations]
              properties:
                profile_ids:
                  type: array
                  items:
                    type: string
                operations:
                  type: array
                  items:
                    type: object
                    required: [op, value]
                    properties:
                      op:
                        type: string
                        enum: [set_group, set_proxy, add_tag, remove_tag, set_start_url]
                      value:
                        type: string
      responses:
        "200":
          description: Batch result

  /api/profiles/import:
    post:
      summary: Import profile from ZIP
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "201":
          description: Imported

  # ─── Groups ──────────────────────────────────────────────────────────────

  /api/groups:
    get:
      summary: List all groups
      x-min-agent-version: "1.1.0"
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 50
      responses:
        "200":
          description: Groups list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Group"
                  total:
                    type: integer
    post:
      summary: Create group
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GroupCreate"
      responses:
        "201":
          description: Group created
        "409":
          description: Name already exists

  /api/groups/{id}:
    patch:
      summary: Update group
      x-min-agent-version: "1.1.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GroupCreate"
      responses:
        "200":
          description: Updated
    delete:
      summary: Delete group (profiles → ungrouped)
      x-min-agent-version: "1.1.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Deleted

  # ─── Tags ────────────────────────────────────────────────────────────────

  /api/tags:
    get:
      summary: List all tags
      x-min-agent-version: "1.1.0"
      responses:
        "200":
          description: All tags
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Tag"
    post:
      summary: Create tag
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TagCreate"
      responses:
        "201":
          description: Tag created
        "409":
          description: Name already exists

  /api/tags/{id}:
    patch:
      summary: Update tag
      x-min-agent-version: "1.1.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TagCreate"
      responses:
        "200":
          description: Updated
    delete:
      summary: Delete tag (removed from all profiles)
      x-min-agent-version: "1.1.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Deleted

  # ─── Sessions ────────────────────────────────────────────────────────────

  /api/sessions/start:
    post:
      summary: Start browser session
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SessionStart"
      responses:
        "200":
          description: Session started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Session"
        "400":
          description: Missing encryptKey (if e2e enabled)
        "409":
          description: Profile locked or already running

  /api/sessions/{id}/stop:
    post:
      summary: Stop session
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Stopped

  /api/sessions/close-all:
    post:
      summary: Stop all running sessions
      x-min-agent-version: "1.0.0"
      responses:
        "200":
          description: All sessions stopped

  /api/sessions/debug-info:
    get:
      summary: Get CDP debug info for all running sessions
      x-min-agent-version: "1.0.0"
      responses:
        "200":
          description: Debug info list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        profile_id:
                          type: string
                        session_id:
                          type: string
                        debug_port:
                          type: integer
                        webdriver:
                          type: string
                        status:
                          type: string

  /api/sessions/process-ids:
    get:
      summary: Get PIDs of all running browser processes
      x-min-agent-version: "1.1.0"
      responses:
        "200":
          description: Process IDs
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        profile_id:
                          type: string
                        session_id:
                          type: string
                        pid:
                          type: integer

  /api/sessions/arrange-windows:
    post:
      summary: Arrange browser windows on screen
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ArrangeWindowsRequest"
      responses:
        "200":
          description: Windows arranged

  /api/sessions/screens:
    get:
      summary: Get monitor/screen information
      x-min-agent-version: "1.1.0"
      responses:
        "200":
          description: Screen list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/ScreenInfo"

  # ─── Proxies ─────────────────────────────────────────────────────────────

  /api/proxies:
    get:
      summary: List proxies
      x-min-agent-version: "1.0.0"
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: Proxy list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Proxy"
                  total:
                    type: integer
    post:
      summary: Add proxy
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProxyCreate"
      responses:
        "201":
          description: Proxy added

  /api/proxies/{id}:
    get:
      summary: Get proxy by ID
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Proxy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Proxy"
    patch:
      summary: Update proxy
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProxyCreate"
      responses:
        "200":
          description: Updated
    delete:
      summary: Delete proxy
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Deleted

  /api/proxies/{id}/test:
    post:
      summary: Test proxy connectivity
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Test result
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ok, timeout, auth_error]
                  ip:
                    type: string
                    nullable: true
                  latency_ms:
                    type: integer
                    nullable: true

  # ─── MoreLogin Compat Endpoints ──────────────────────────────────────────
  # These endpoints mirror MoreLogin public API paths for drop-in compatibility.
  # Requires compat mode enabled: config `compatibility.enabled: true`

  /api/env/create/quick:
    post:
      summary: "[Compat] Create profile (quick)"
      description: "MoreLogin-compatible alias for POST /api/profiles"
      tags: [compat]
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                groupId:
                  type: string
                remark:
                  type: string
                proxyId:
                  type: string
            example:
              name: "Test Profile 1"
              groupId: null
              remark: null
              proxyId: null
      responses:
        "200":
          description: MoreLogin-envelope response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  envId: "550e8400-e29b-41d4-a716-446655440000"
                  name: "Test Profile 1"
                  groupId: null
                  status: "stopped"
                requestId: "req-create-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "404":
          description: Compat mode not enabled
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/create/advanced:
    post:
      summary: "[Compat] Create profile (advanced)"
      description: "MoreLogin-compatible alias for POST /api/profiles with full configuration"
      tags: [compat]
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                groupId:
                  type: string
                remark:
                  type: string
                proxyId:
                  type: string
                startUrl:
                  type: string
                extensionIds:
                  type: array
                  items:
                    type: string
                browserVersion:
                  type: string
                osVersion:
                  type: string
                userAgent:
                  type: string
                screenResolution:
                  type: string
                timezone:
                  type: string
                language:
                  type: string
            example:
              name: "Advanced Profile"
              remark: "my test env"
              timezone: "Asia/Ho_Chi_Minh"
              language: "vi-VN"
              screenResolution: "1920x1080"
      responses:
        "200":
          description: MoreLogin-envelope response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  envId: "550e8400-e29b-41d4-a716-446655440001"
                  name: "Advanced Profile"
                  status: "stopped"
                requestId: "req-create-adv-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "404":
          description: Compat mode not enabled
        "409":
          $ref: "#/components/responses/Conflict409"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/start:
    post:
      summary: "[Compat] Start browser session"
      description: "MoreLogin-compatible alias for POST /api/sessions/start"
      tags: [compat]
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
                  description: Profile/env ID
                headless:
                  type: boolean
                  default: false
                encryptKey:
                  type: string
                  description: "[Restricted] Required if e2e encryption enabled"
            example:
              id: "550e8400-e29b-41d4-a716-446655440000"
              headless: false
      responses:
        "200":
          description: MoreLogin-envelope with debugPort, webdriver, version
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  jobId: "job-001"
                  envId: "550e8400-e29b-41d4-a716-446655440000"
                  status: "succeeded"
                  debugPort: 9222
                  wsEndpoint: "ws://localhost:9222/devtools/browser/abc123"
                  webDriverUrl: "http://localhost:9222"
                requestId: "req-start-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "409":
          $ref: "#/components/responses/Conflict409"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/close:
    post:
      summary: "[Compat] Stop session"
      tags: [compat]
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
            example:
              id: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data: null
                requestId: "req-close-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/closeAll:
    post:
      summary: "[Compat] Stop all sessions"
      tags: [compat]
      x-min-agent-version: "1.0.0"
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  stopped: 3
                requestId: "req-closeall-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/active:
    post:
      summary: "[Compat] Bring session window to foreground"
      description: |
        MoreLogin-compatible alias. Brings the browser window of a running session to the foreground
        using the Windows SetForegroundWindow API. If `id` is omitted, returns a list of all running
        sessions (same as GET /api/sessions?status=running).
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                id:
                  type: string
                  description: |
                    Profile/env ID. If provided, focuses that session's browser window (Windows
                    SetForegroundWindow). If omitted, returns list of running sessions.
            example:
              id: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        "200":
          description: |
            MoreLogin-envelope. When `id` is provided: `{code:0, msg:"success", data:{focused:true}}`.
            When `id` is omitted: `{code:0, msg:"success", data:[...sessions]}`.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  focused: true
                requestId: "req-active-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "404":
          description: Session not found or not running
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/reopen:
    post:
      summary: "[Compat] Reopen (restart) a session"
      description: |
        MoreLogin-compatible alias. Closes the running session (if any) and restarts it.
        Functionally equivalent to POST /api/sessions/start with restart semantics.
        Alias for POST /api/sessions/start (with implicit stop if already running).
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
                  description: Profile/env ID to reopen
                openWidth:
                  type: integer
                  default: 1280
                openHeight:
                  type: integer
                  default: 800
            example:
              id: "550e8400-e29b-41d4-a716-446655440000"
              openWidth: 1280
              openHeight: 800
      responses:
        "200":
          description: MoreLogin-envelope with debugPort, webdriver, browserVersion
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  envId: "550e8400-e29b-41d4-a716-446655440000"
                  debugPort: 9222
                  wsEndpoint: "ws://localhost:9222/devtools/browser/abc123"
                  webDriverUrl: "http://localhost:9222"
                requestId: "req-reopen-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "409":
          $ref: "#/components/responses/Conflict409"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/update:
    post:
      summary: "[Compat] Update profile fields"
      description: |
        MoreLogin-compatible alias for PATCH /api/profiles/{id}.
        Accepts MoreLogin-style field names and translates to native profile fields.
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
                  description: Profile/env UUID to update
                name:
                  type: string
                groupId:
                  type: string
                remark:
                  type: string
                proxyId:
                  type: string
                userAgent:
                  type: string
                osVersion:
                  type: string
                resolution:
                  type: string
                  example: "1920_1080"
                timezone:
                  type: string
                language:
                  type: string
            example:
              id: "550e8400-e29b-41d4-a716-446655440000"
              name: "Updated Profile Name"
              remark: "updated remark"
      responses:
        "200":
          description: MoreLogin-envelope with updated profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  envId: "550e8400-e29b-41d4-a716-446655440000"
                  name: "Updated Profile Name"
                requestId: "req-update-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "404":
          description: Profile not found
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/list:
    post:
      summary: "[Compat] List profiles"
      description: "MoreLogin-compatible alias for GET /api/profiles with pagination"
      tags: [compat]
      x-min-agent-version: "1.0.0"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                pageSize:
                  type: integer
                  default: 20
                groupId:
                  type: string
                tagId:
                  type: string
                status:
                  type: integer
                  description: "0=inactive,1=active,2=error"
            example:
              page: 1
              pageSize: 20
      responses:
        "200":
          description: MoreLogin-envelope with profile list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  list:
                    - envId: "550e8400-e29b-41d4-a716-446655440000"
                      name: "Test Profile 1"
                      status: "stopped"
                  total: 1
                requestId: "req-list-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/detail:
    post:
      summary: "[Compat] Get profile detail"
      description: "MoreLogin-compatible alias for GET /api/profiles/{id}"
      tags: [compat]
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
                  description: Profile/env UUID
            example:
              id: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        "200":
          description: MoreLogin-envelope with profile details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  envId: "550e8400-e29b-41d4-a716-446655440000"
                  name: "Test Profile 1"
                  status: "stopped"
                  groupId: null
                  remark: null
                requestId: "req-detail-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "404":
          description: Profile not found
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/removeToRecycleBin/batch:
    post:
      summary: "[Compat] Delete profiles (soft delete → trash / recycle bin)"
      description: |
        MoreLogin-compatible endpoint for batch deleting profiles.
        Moves profiles to trash (soft delete). Use /api/profiles/{id}/permanent for hard delete.
        This is the correct MoreLogin endpoint name (not /api/env/delete).
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [ids]
              properties:
                ids:
                  type: array
                  items:
                    type: string
                  description: Array of profile/env UUIDs to move to recycle bin (supports batch)
                  minItems: 1
            example:
              ids:
                - "550e8400-e29b-41d4-a716-446655440000"
                - "550e8400-e29b-41d4-a716-446655440001"
      responses:
        "200":
          description: MoreLogin-envelope confirming deletion
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  deleted: 2
                requestId: "req-trash-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "404":
          description: One or more profiles not found
        "409":
          $ref: "#/components/responses/Conflict409"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/page:
    post:
      summary: "[Compat] Paginated profile list with filters"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                pageSize:
                  type: integer
                  default: 20
                name:
                  type: string
                groupId:
                  type: string
                tagId:
                  type: string
                status:
                  type: integer
                  description: "0=inactive,1=active,2=error"
                proxyType:
                  type: string
                sortField:
                  type: string
                sortOrder:
                  type: string
                  enum: [asc, desc]
            example:
              page: 1
              pageSize: 20
              name: ""
      responses:
        "200":
          description: MoreLogin-envelope with paginated list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  list:
                    - envId: "550e8400-e29b-41d4-a716-446655440000"
                      name: "Test Profile 1"
                      status: "stopped"
                  total: 1
                  page: 1
                  pageSize: 20
                requestId: "req-page-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/getAllDebugInfo:
    post:
      summary: "[Compat] Get CDP debug info for all running sessions"
      tags: [compat]
      x-min-agent-version: "1.0.0"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties: {}
            example: {}
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  - id: "550e8400-e29b-41d4-a716-446655440000"
                    http: "127.0.0.1:9222"
                    ws: "ws://127.0.0.1:9222/devtools/browser/abc123"
                requestId: "req-debug-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/getAllProcessIds:
    post:
      summary: "[Compat] Get PIDs of all browser processes"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties: {}
            example: {}
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  - envId: "550e8400-e29b-41d4-a716-446655440000"
                    pid: 12345
                requestId: "req-pids-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/getAllScreen:
    post:
      summary: "[Compat] Get screen/monitor information"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties: {}
            example: {}
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  - screenId: 0
                    width: 1920
                    height: 1080
                    isPrimary: true
                requestId: "req-screen-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/removeLocalCache:
    post:
      summary: "[Compat] Remove local cache for profile"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
                cacheTypes:
                  type: array
                  items:
                    type: string
            example:
              id: "550e8400-e29b-41d4-a716-446655440000"
              cacheTypes: ["cookies", "local_storage"]
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  bytesFreed: 204800
                requestId: "req-cache-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "409":
          $ref: "#/components/responses/Conflict409"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/env/cache/cleanCloud:
    post:
      summary: "[Compat] Clean cloud cache — NOT IMPLEMENTED for self-hosted"
      description: >
        Cloud cache is not supported in self-hosted mode. This endpoint always returns 501.
        Use POST /api/env/removeLocalCache for local cache cleaning instead.
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
            example: {}
      responses:
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"
        "501":
          description: Not Implemented — cloud cache not available in self-hosted mode
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: -1501
                msg: "Cloud cache not supported in self-hosted mode"
                data:
                  alternative: "POST /api/env/removeLocalCache"
                  docs: "https://github.com/lizamazieva41-ai/bower/blob/main/tai-lieu-du-an/scope-exceptions.md"
                requestId: "req-err-501-cloud"

  /api/env/arrangeWindows:
    post:
      summary: "[Compat] Arrange browser windows on screen"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ArrangeWindowsRequest"
            example:
              ids:
                - "550e8400-e29b-41d4-a716-446655440000"
                - "550e8400-e29b-41d4-a716-446655440001"
              layout: "grid"
              monitor_index: 0
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  arranged: 2
                requestId: "req-arrange-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/envgroup/page:
    post:
      summary: "[Compat] Paginated group list"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                pageSize:
                  type: integer
                  default: 20
                name:
                  type: string
            example:
              page: 1
              pageSize: 20
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  list:
                    - id: "g-001"
                      name: "Group A"
                      profileCount: 5
                  total: 1
                requestId: "req-grppage-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/envgroup/create:
    post:
      summary: "[Compat] Create group"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GroupCreate"
            example:
              name: "My Group"
              color: "#FF5733"
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  id: "g-001"
                  name: "My Group"
                  color: "#FF5733"
                requestId: "req-grpcreate-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "409":
          $ref: "#/components/responses/Conflict409"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/envgroup/edit:
    post:
      summary: "[Compat] Edit group"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - type: object
                  required: [id]
                  properties:
                    id:
                      type: string
                - $ref: "#/components/schemas/GroupCreate"
            example:
              id: "g-001"
              name: "Renamed Group"
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  id: "g-001"
                  name: "Renamed Group"
                requestId: "req-grpedit-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "409":
          $ref: "#/components/responses/Conflict409"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/envgroup/delete:
    post:
      summary: "[Compat] Delete group"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
            example:
              id: "g-001"
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data: null
                requestId: "req-grpdel-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/envtag/all:
    get:
      summary: "[Compat] Get all tags (no pagination)"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      responses:
        "200":
          description: MoreLogin-envelope with tag list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  - id: "t-001"
                    name: "VIP"
                    color: "#FF0000"
                    envCount: 3
                requestId: "req-tagall-001"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/envtag/create:
    post:
      summary: "[Compat] Create tag"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TagCreate"
            example:
              name: "VIP"
              color: "#FF0000"
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  id: "t-001"
                  name: "VIP"
                  color: "#FF0000"
                requestId: "req-tagcreate-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "409":
          $ref: "#/components/responses/Conflict409"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/envtag/edit:
    post:
      summary: "[Compat] Edit tag"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - type: object
                  required: [id]
                  properties:
                    id:
                      type: string
                - $ref: "#/components/schemas/TagCreate"
            example:
              id: "t-001"
              name: "Premium"
              color: "#FFD700"
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  id: "t-001"
                  name: "Premium"
                  color: "#FFD700"
                requestId: "req-tagedit-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "409":
          $ref: "#/components/responses/Conflict409"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/envtag/delete:
    post:
      summary: "[Compat] Delete tag"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
            example:
              id: "t-001"
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data: null
                requestId: "req-tagdel-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/proxyInfo/page:
    post:
      summary: "[Compat] Paginated proxy list"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                pageSize:
                  type: integer
                  default: 20
            example:
              page: 1
              pageSize: 20
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  list:
                    - id: "p-001"
                      type: "socks5"
                      host: "proxy.example.com"
                      port: 1080
                      profileCount: 2
                  total: 1
                requestId: "req-proxypage-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/proxyInfo/add:
    post:
      summary: "[Compat] Add proxy"
      tags: [compat]
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProxyCreate"
            example:
              type: "socks5"
              host: "proxy.example.com"
              port: 1080
              username: "user"
              password: "pass"
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  id: "p-001"
                  type: "socks5"
                  host: "proxy.example.com"
                  port: 1080
                requestId: "req-proxyadd-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "409":
          $ref: "#/components/responses/Conflict409"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/proxyInfo/update:
    post:
      summary: "[Compat] Update proxy"
      tags: [compat]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - type: object
                  required: [id]
                  properties:
                    id:
                      type: string
                - $ref: "#/components/schemas/ProxyCreate"
            example:
              id: "p-001"
              host: "proxy2.example.com"
              port: 1080
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data:
                  id: "p-001"
                  host: "proxy2.example.com"
                  port: 1080
                requestId: "req-proxyupdate-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/proxyInfo/delete:
    post:
      summary: "[Compat] Delete proxy"
      tags: [compat]
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
            example:
              id: "p-001"
      responses:
        "200":
          description: MoreLogin-envelope
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompatEnvelope"
              example:
                code: 0
                msg: "success"
                data: null
                requestId: "req-proxydel-001"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "403":
          $ref: "#/components/responses/Forbidden403"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  # ─── Extensions ──────────────────────────────────────────────────────────

  /api/extensions:
    get:
      summary: List central extension registry
      x-min-agent-version: "1.0.0"
      responses:
        "200":
          description: Extension list
    post:
      summary: Add extension to registry
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExtensionCreate"
      responses:
        "201":
          description: Added

  /api/extensions/{id}:
    delete:
      summary: Remove extension from registry
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Removed

  /api/extensions/{id}/assign:
    post:
      summary: Assign/remove extension to/from profiles
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [action, profile_ids]
              properties:
                action:
                  type: string
                  enum: [add, remove]
                profile_ids:
                  type: array
                  items:
                    type: string
      responses:
        "200":
          description: Assigned

  # ─── Scripts ─────────────────────────────────────────────────────────────

  /api/scripts:
    get:
      summary: List registered scripts
      x-min-agent-version: "1.0.0"
      responses:
        "200":
          description: Script list
    post:
      summary: Register script
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ScriptCreate"
      responses:
        "201":
          description: Registered

  /api/scripts/{id}:
    delete:
      summary: Unregister script
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Removed

  /api/scripts/run:
    post:
      summary: Run a script
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [script_id, profile_id]
              properties:
                script_id:
                  type: string
                profile_id:
                  type: string
                params:
                  type: object
                timeout_sec:
                  type: integer
      responses:
        "202":
          description: Job queued

  # ─── Jobs ────────────────────────────────────────────────────────────────

  /api/jobs:
    get:
      summary: List jobs
      x-min-agent-version: "1.0.0"
      parameters:
        - name: status
          in: query
          schema:
            type: string
        - name: profile_id
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: Job list

  /api/jobs/{id}:
    get:
      summary: Get job details
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Job detail
        "404":
          description: Not found

  /api/jobs/{id}/cancel:
    post:
      summary: Cancel job
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Cancelled

  /api/jobs/{id}/logs:
    get:
      summary: Get job logs
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Log entries

  /api/logs/stream:
    get:
      summary: Stream logs via Server-Sent Events
      x-min-agent-version: "1.0.0"
      parameters:
        - name: job_id
          in: query
          schema:
            type: string
        - name: level
          in: query
          schema:
            type: string
            enum: [INFO, WARN, ERROR, DEBUG]
      responses:
        "200":
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string

  # ─── Profile Sync (Sync Contract) ────────────────────────────────────────

  /api/sync/capabilities:
    get:
      summary: "Profile Sync: Get peer capabilities (schema versions & conflict strategies)"
      description: >
        Returns the schema versions and conflict strategies supported by this agent.
        Callers MUST call this endpoint before the first push/pull to negotiate a
        compatible schema version. See `24-browser-sync-contract.md` §5.1.
      tags: [profile-sync]
      x-min-agent-version: "1.1.0"
      security:
        - BearerToken: []
      responses:
        "200":
          description: Capabilities of this agent
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyncCapabilitiesResponse"
              example:
                agent_id: "agent-primary-01"
                schema_versions: ["1.0"]
                conflict_strategies: ["last_write_wins", "field_merge"]
        "401":
          $ref: "#/components/responses/Unauthorized401"

  /api/sync/push:
    post:
      summary: "Profile Sync: Receive a SyncUnit pushed from a peer agent"
      description: >
        Accepts a SyncUnit from a peer agent.  The receiver validates the checksum,
        compares sync_version, applies the payload (or runs conflict resolution), and
        updates sync_metadata.  See `24-browser-sync-contract.md` §3.3.
      tags: [profile-sync]
      x-min-agent-version: "1.1.0"
      security:
        - BearerToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sync_unit]
              properties:
                sync_unit:
                  $ref: "#/components/schemas/SyncUnit"
            example:
              sync_unit:
                schema_version: "1.0"
                profile_id: "550e8400-e29b-41d4-a716-446655440000"
                agent_id: "agent-primary-01"
                sync_version: 7
                operation: "update"
                last_modified_at: "2026-02-21T08:30:00Z"
                checksum: "sha256:aabbccdd..."
                payload:
                  name: "Profile A"
                  group_id: "grp-001"
                  remark: "Account farming VN"
                  tags: ["vn", "farming"]
                  proxy_id: "proxy-007"
                  start_url: "https://example.com"
                  user_agent: "Mozilla/5.0 ..."
                  kernel_ver: "120.0.6099.109"
                  os_version: "Windows 10"
                  screen_res: "1920x1080"
                  timezone: "Asia/Ho_Chi_Minh"
                  language: "vi-VN,vi;q=0.9"
                  headless_default: false
                  extensions: []
                  metadata: {}
      responses:
        "200":
          description: SyncUnit accepted (conflict resolved if applicable)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyncPushResponse"
              examples:
                no_conflict:
                  summary: Accepted without conflict
                  value:
                    accepted: true
                    profile_id: "550e8400-e29b-41d4-a716-446655440000"
                    peer_sync_ver: 7
                    resolved: null
                    winning_agent: null
                conflict_resolved:
                  summary: Conflict resolved via last_write_wins
                  value:
                    accepted: true
                    profile_id: "550e8400-e29b-41d4-a716-446655440000"
                    peer_sync_ver: 9
                    resolved: "last_write_wins"
                    winning_agent: "agent-primary-01"
        "400":
          description: Checksum mismatch or malformed SyncUnit (`sync.checksum_mismatch`)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "409":
          description: Conflict cannot be auto-resolved (`sync.conflict.unresolved`)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Schema version incompatible (`sync.schema_incompatible`)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/sync/pull:
    get:
      summary: "Profile Sync: Pull SyncUnits with sync_version greater than a given value"
      description: >
        Returns all SyncUnits whose `sync_version` is greater than `since_version`.
        Use `since_version=0` for initial full sync (peer join).
        See `24-browser-sync-contract.md` §3.4 and §3.6.
      tags: [profile-sync]
      x-min-agent-version: "1.1.0"
      security:
        - BearerToken: []
      parameters:
        - name: since_version
          in: query
          required: true
          schema:
            type: integer
            minimum: 0
          description: "Return SyncUnits with sync_version > this value. Use 0 for full sync."
          example: 7
        - name: agent_id
          in: query
          required: true
          schema:
            type: string
          description: "ID of the requesting agent (used for logging)"
          example: "agent-secondary-01"
      responses:
        "200":
          description: List of SyncUnits newer than since_version
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyncPullResponse"
              example:
                agent_id: "agent-primary-01"
                units:
                  - sync_unit:
                      schema_version: "1.0"
                      profile_id: "550e8400-e29b-41d4-a716-446655440000"
                      agent_id: "agent-primary-01"
                      sync_version: 8
                      operation: "update"
                      last_modified_at: "2026-02-21T09:00:00Z"
                      checksum: "sha256:ccddee..."
                      payload:
                        name: "Profile A (updated)"
                        group_id: "grp-001"
                        remark: ""
                        tags: []
                        proxy_id: "proxy-007"
                        start_url: "https://example.com"
                        user_agent: "Mozilla/5.0 ..."
                        kernel_ver: "120.0.6099.109"
                        os_version: "Windows 10"
                        screen_res: "1920x1080"
                        timezone: "Asia/Ho_Chi_Minh"
                        language: "vi-VN,vi;q=0.9"
                        headless_default: false
                        extensions: []
                        metadata: {}
                total: 1
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "422":
          description: Schema version incompatible (`sync.schema_incompatible`)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/SystemError500"

  # ─── Browser Sync ─────────────────────────────────────────────────────────

  /api/sync/start:
    post:
      summary: Start browser sync session (Leader → Followers)
      tags: [sync]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [leader_session_id, follower_session_ids]
              properties:
                leader_session_id:
                  type: string
                  description: Session ID of the leader browser
                follower_session_ids:
                  type: array
                  items:
                    type: string
                  description: Session IDs of follower browsers
                sync_operations:
                  type: array
                  items:
                    type: string
                    enum: [mouse, keyboard, scroll, navigation, tab]
                  default: [mouse, keyboard, scroll, navigation, tab]
            example:
              leader_session_id: "session-uuid-profile-a"
              follower_session_ids: ["session-uuid-profile-b", "session-uuid-profile-c"]
              sync_operations: ["mouse", "keyboard", "scroll", "navigation"]
      responses:
        "200":
          description: Sync session started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NativeEnvelope"
              example:
                data:
                  sync_id: "sync-uuid-abc123"
                  leader: "session-uuid-profile-a"
                  followers:
                    - session_id: "session-uuid-profile-b"
                      status: "connected"
                    - session_id: "session-uuid-profile-c"
                      status: "connected"
                  started_at: "2026-02-20T10:00:00Z"
                request_id: "req-sync-001"
                timestamp: "2026-02-20T10:00:00Z"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "409":
          description: Sync session already active
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/sync/stop:
    post:
      summary: Stop active browser sync session
      tags: [sync]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sync_id]
              properties:
                sync_id:
                  type: string
            example:
              sync_id: "sync-uuid-abc123"
      responses:
        "200":
          description: Sync session stopped
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NativeEnvelope"
              example:
                data:
                  stopped_at: "2026-02-20T10:05:00Z"
                request_id: "req-sync-002"
                timestamp: "2026-02-20T10:05:00Z"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "404":
          description: Sync session not found
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/sync/status:
    get:
      summary: Get current browser sync session status
      tags: [sync]
      x-min-agent-version: "1.1.0"
      responses:
        "200":
          description: Current sync status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NativeEnvelope"
              example:
                data:
                  active: true
                  sync_id: "sync-uuid-abc123"
                  leader_session_id: "session-uuid-profile-a"
                  followers:
                    - session_id: "session-uuid-profile-b"
                      status: "connected"
                      lag_ms: 45
                    - session_id: "session-uuid-profile-c"
                      status: "connected"
                      lag_ms: 120
                  events_dispatched: 1502
                  started_at: "2026-02-20T10:00:00Z"
                request_id: "req-sync-003"
                timestamp: "2026-02-20T10:02:00Z"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  /api/sync/event:
    post:
      summary: Dispatch sync event from leader to followers via CDP relay
      tags: [sync]
      x-min-agent-version: "1.1.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sync_id, event_type, payload]
              properties:
                sync_id:
                  type: string
                event_type:
                  type: string
                  enum: [mouse_click, mouse_move, key_down, key_up, scroll, navigate, tab_open, tab_close]
                payload:
                  type: object
                  description: Event-specific payload (coordinates, key codes, URL, etc.)
            example:
              sync_id: "sync-uuid-abc123"
              event_type: "mouse_click"
              payload:
                x_ratio: 0.52
                y_ratio: 0.33
                button: "left"
                click_count: 1
      responses:
        "200":
          description: Event dispatched to followers
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NativeEnvelope"
              example:
                data:
                  dispatched_to: 3
                  failed: 0
                request_id: "req-sync-004"
                timestamp: "2026-02-20T10:01:00Z"
        "400":
          $ref: "#/components/responses/BadRequest400"
        "401":
          $ref: "#/components/responses/Unauthorized401"
        "404":
          description: Sync session not found or expired
        "429":
          $ref: "#/components/responses/RateLimit429"
        "500":
          $ref: "#/components/responses/SystemError500"

  # ─── Webhooks ────────────────────────────────────────────────────────────

  /api/webhooks:
    get:
      summary: List webhooks
      x-min-agent-version: "1.0.0"
      responses:
        "200":
          description: Webhook list
    post:
      summary: Register webhook
      x-min-agent-version: "1.0.0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WebhookCreate"
      responses:
        "201":
          description: Registered

  /api/webhooks/{id}:
    delete:
      summary: Delete webhook
      x-min-agent-version: "1.0.0"
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Deleted
